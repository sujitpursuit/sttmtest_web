<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STTM Impact Analysis Tool</title>
    
    <!-- Configuration (must load first) -->
    <script src="/static/js/config.js"></script>
    
    <!-- Custom JavaScript (must load before Alpine.js) -->
    <script src="/static/js/app.js"></script>
    
    <!-- Alpine.js CDN -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div id="app" x-data="sttmApp()" x-init="init()">
        
        <!-- Header -->
        <header class="header">
            <div class="container">
                <h1>üîç STTM Impact Analysis Tool</h1>
                <p>Upload, validate, analyze, and generate test steps</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container">
            
            <!-- Progress Indicator -->
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" :style="`width: ${progressPercentage}%`"></div>
                </div>
                <div class="progress-steps">
                    <span :class="{'step-active': currentStep >= 1, 'step-completed': currentStep > 1}">
                        üìÅ Upload
                    </span>
                    <span :class="{'step-active': currentStep >= 2, 'step-completed': currentStep > 2}">
                        ‚úÖ Validate
                    </span>
                    <span :class="{'step-active': currentStep >= 3, 'step-completed': currentStep > 3}">
                        üìä Analyze
                    </span>
                    <span :class="{'step-active': currentStep >= 4, 'step-completed': currentStep > 4}">
                        üß™ Generate
                    </span>
                </div>
            </div>

            <!-- File Selection Section -->
            <section class="upload-section">
                <h2>üìÅ Step 1: Select Comparison & Upload QTest</h2>
                
                <!-- Tracked File Selection -->
                <div class="file-upload-container">
                    <h3>üìÇ Select Tracked File</h3>
                    
                    <div class="dropdown-container">
                        <select x-model="selectedFile?.id" 
                                @change="selectTrackedFile(parseInt($event.target.value))"
                                :disabled="isLoading.trackedFiles"
                                class="tracked-file-dropdown">
                            <option value="">
                                <span x-show="isLoading.trackedFiles">‚è≥ Loading tracked files...</span>
                                <span x-show="!isLoading.trackedFiles">Select a tracked file...</span>
                            </option>
                            <template x-for="file in trackedFiles" :key="file.id">
                                <option :value="file.id" x-text="file.friendly_name"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div x-show="selectedFile" class="selected-file-info">
                        <div class="info-card">
                            <h4>üìÑ Selected File</h4>
                            <p><strong>Name:</strong> <span x-text="selectedFile?.file_name"></span></p>
                            <p><strong>Friendly Name:</strong> <span x-text="selectedFile?.friendly_name"></span></p>
                            <p><strong>Created:</strong> <span x-text="formatDate(selectedFile?.created_at)"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Version Comparison Selection -->
                <div class="file-upload-container" x-show="selectedFile">
                    <h3>üîç Select Version Comparison</h3>
                    
                    <div x-show="isLoading.comparisons" class="loading-message">
                        ‚è≥ Loading comparisons...
                    </div>
                    
                    <div x-show="!isLoading.comparisons && comparisons.length === 0 && selectedFile" class="no-data-message">
                        üì≠ No comparisons found for this file.
                    </div>
                    
                    <div x-show="!isLoading.comparisons && comparisons.length > 0" class="comparisons-grid">
                        <template x-for="comparison in comparisons" :key="comparison.comparison_id">
                            <div class="comparison-card"
                                 :class="{'selected': selectedComparison?.comparison_id === comparison.comparison_id}"
                                 @click="selectComparison(comparison.comparison_id)">
                                
                                <div class="card-header">
                                    <h4 x-text="comparison.comparison_title"></h4>
                                    <div class="card-badge" x-text="comparison.comparison_status"></div>
                                    <div class="comparison-id">ID: <span x-text="comparison.comparison_id"></span></div>
                                </div>
                                
                                <div class="card-content">
                                    <div class="version-info">
                                        <div class="version-pair">
                                            <div class="version-block">
                                                <span class="version-label">From:</span>
                                                <span class="version-text" x-text="`v${comparison.from_sharepoint_version} (#${comparison.from_sequence})`"></span>
                                                <span class="version-date" x-text="formatDate(comparison.from_modified)"></span>
                                            </div>
                                            <div class="version-arrow">‚Üí</div>
                                            <div class="version-block">
                                                <span class="version-label">To:</span>
                                                <span class="version-text" x-text="`v${comparison.to_sharepoint_version} (#${comparison.to_sequence})`"></span>
                                                <span class="version-date" x-text="formatDate(comparison.to_modified)"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="changes-summary">
                                        <div class="changes-total">
                                            <span class="changes-number" x-text="comparison.total_changes"></span>
                                            <span class="changes-label">Total Changes</span>
                                        </div>
                                        <div class="changes-breakdown">
                                            <span class="change-item added" x-text="`+${comparison.added_mappings}`"></span>
                                            <span class="change-item modified" x-text="`~${comparison.modified_mappings}`"></span>
                                            <span class="change-item deleted" x-text="`-${comparison.deleted_mappings}`"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="comparison-meta">
                                        <p class="comparison-date">üìÖ <span x-text="formatDate(comparison.comparison_taken_at)"></span></p>
                                    </div>
                                </div>
                                
                                <div class="card-footer">
                                    <span x-show="selectedComparison?.comparison_id === comparison.comparison_id" class="selected-indicator">‚úÖ Selected</span>
                                    <span x-show="selectedComparison?.comparison_id !== comparison.comparison_id" class="click-to-select">Click to select</span>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div x-show="selectedComparison" class="selected-comparison-info">
                        <div class="info-card selected">
                            <h4>‚úÖ Selected Comparison</h4>
                            <p><strong>Title:</strong> <span x-text="selectedComparison?.comparison_title"></span></p>
                            <p><strong>Versions:</strong> <span x-text="formatVersionDisplay(selectedComparison)"></span></p>
                            <p><strong>Changes:</strong> <span x-text="selectedComparison?.total_changes"></span> total</p>
                        </div>
                    </div>
                    
                    <!-- NEW: Azure QTest Upload Section -->
                    <div x-show="selectedComparison" class="azure-qtest-section">
                        <div class="info-card">
                            <h4>üìä Upload QTest File to Azure</h4>
                            <div x-show="!hasQTestInAzure()">
                                <p>Upload QTest file for this comparison (will be stored in Azure Blob Storage)</p>
                                <input type="file" 
                                       accept=".xlsx,.xls" 
                                       @change="uploadQTestToAzure($event)"
                                       :disabled="isLoading.upload"
                                       class="file-input-azure">
                                <span x-show="isLoading.upload" class="loading-text">‚è≥ Uploading and validating...</span>
                            </div>
                            <div x-show="hasQTestInAzure()" class="qtest-uploaded-info">
                                <p class="success-message">‚úÖ QTest file uploaded to Azure</p>
                                <p><strong>Test Cases:</strong> <span x-text="qtestBlobInfo?.validation?.test_cases || 0"></span></p>
                                <p><strong>Worksheets:</strong> <span x-text="qtestBlobInfo?.validation?.worksheets || 0"></span></p>
                                <button @click="qtestBlobInfo = null" class="btn btn-small">Upload Different File</button>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- Action Buttons Section -->
            <section class="actions-section">
                
                <!-- Validate Files Button -->
                <div class="action-group">
                    <button @click="validateFiles()" 
                            :disabled="!canValidateFiles() || workflow.filesValidated" 
                            :class="{
                                'btn-primary': canValidateFiles() && !workflow.filesValidated, 
                                'btn-disabled': !canValidateFiles() || workflow.filesValidated,
                                'btn-success': workflow.filesValidated
                            }"
                            class="btn btn-large">
                        <span x-show="!isLoading.validation && !workflow.filesValidated">‚úÖ Validate Files</span>
                        <span x-show="isLoading.validation">‚è≥ Validating...</span>
                        <span x-show="workflow.filesValidated && !isLoading.validation">‚úÖ Files Validated</span>
                    </button>
                    <p class="action-hint" x-show="!canValidateFiles() && !workflow.filesValidated">
                        Please select a version comparison and upload QTest Excel file
                    </p>
                </div>

                <!-- Analyze Impact Button -->
                <div class="action-group" x-show="workflow.filesValidated">
                    <button @click="analyzeImpact()" 
                            :disabled="isLoading.analysis || workflow.impactAnalyzed" 
                            :class="{
                                'btn-primary': !isLoading.analysis && !workflow.impactAnalyzed,
                                'btn-disabled': isLoading.analysis,
                                'btn-success': workflow.impactAnalyzed
                            }"
                            class="btn btn-large">
                        <span x-show="!isLoading.analysis && !workflow.impactAnalyzed">üìä Analyze Impact</span>
                        <span x-show="isLoading.analysis">‚è≥ Analyzing...</span>
                        <span x-show="workflow.impactAnalyzed && !isLoading.analysis">üìä Impact Analyzed</span>
                    </button>
                    <p class="action-hint" x-show="!workflow.impactAnalyzed">
                        Analyze the impact of STTM changes on QTest cases
                    </p>
                </div>
                
                <!-- Test Step Generation Buttons -->
                <div class="action-group" x-show="workflow.impactAnalyzed">
                    <div class="btn-group">
                        <button @click="generateTestSteps('delta')" 
                                :disabled="isLoading.generation || workflow.deltaGenerated"
                                :class="{
                                    'btn-primary': !isLoading.generation && !workflow.deltaGenerated,
                                    'btn-disabled': isLoading.generation,
                                    'btn-success': workflow.deltaGenerated
                                }"
                                class="btn">
                            <span x-show="!isLoading.generation && !workflow.deltaGenerated">üîÑ Generate Delta QTest</span>
                            <span x-show="isLoading.generation && generationType === 'delta'">‚è≥ Generating...</span>
                            <span x-show="workflow.deltaGenerated && !isLoading.generation">‚úÖ Delta Generated</span>
                        </button>
                        
                        <button @click="generateTestSteps('in-place')" 
                                :disabled="!workflow.deltaGenerated || isLoading.generation || workflow.inPlaceGenerated"
                                :class="{
                                    'btn-primary': workflow.deltaGenerated && !workflow.inPlaceGenerated && !isLoading.generation,
                                    'btn-disabled': !workflow.deltaGenerated || isLoading.generation,
                                    'btn-success': workflow.inPlaceGenerated
                                }"
                                class="btn">
                            <span x-show="!isLoading.generation && !workflow.inPlaceGenerated">üìù Generate In-Place QTest</span>
                            <span x-show="isLoading.generation && generationType === 'in-place'">‚è≥ Generating...</span>
                            <span x-show="workflow.inPlaceGenerated && !isLoading.generation">‚úÖ In-Place Generated</span>
                        </button>
                    </div>
                    <p class="action-hint" x-show="!workflow.deltaGenerated">
                        Generate delta test steps first (required before in-place generation)
                    </p>
                </div>
                
            </section>

            <!-- Results Section -->
            <section class="results-section" x-show="analysisResult">
                <h2>üìä Analysis Results</h2>
                
                <!-- Summary Cards -->
                <div class="results-grid" x-show="analysisResult">
                    <div class="result-card">
                        <div class="card-icon">üìà</div>
                        <div class="card-content">
                            <h3>Impact Summary</h3>
                            <p class="card-value" x-text="getAnalysisSummary()"></p>
                        </div>
                    </div>
                    
                    <div class="result-card" x-show="analysisResult && analysisResult.report_links">
                        <div class="card-icon">üìÑ</div>
                        <div class="card-content">
                            <h3>Impact Analysis Reports</h3>
                            <div class="report-links">
                                <a :href="analysisResult && analysisResult.report_links && analysisResult.report_links.html_url ? analysisResult.report_links.html_url : ''" 
                                   target="_blank" 
                                   class="report-link"
                                   x-show="analysisResult && analysisResult.report_links && analysisResult.report_links.html_url">
                                    üåê View Impact HTML Report
                                </a>
                                <button @click="downloadJSON()" 
                                        class="btn btn-secondary"
                                        x-show="analysisResult && analysisResult.report_links && analysisResult.report_links.json_url">
                                    üì• Download Impact JSON Report
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Test Step Generation Reports -->
                    <div class="result-card" x-show="testStepResults && Object.keys(testStepResults).length > 0">
                        <div class="card-icon">üìù</div>
                        <div class="card-content">
                            <h3>Test Step Generation Reports</h3>
                            
                            <!-- Delta Reports -->
                            <div class="test-step-reports" x-show="testStepResults.delta">
                                <h4 class="generation-mode">üîÑ Delta Mode:</h4>
                                <div class="report-links">
                                    <a :href="getTestStepExcelUrl('delta')" 
                                       target="_blank" 
                                       class="report-link"
                                       x-show="testStepResults.delta && testStepResults.delta.excel_url">
                                        üìà View Delta Excel Report
                                    </a>
                                    <a :href="getTestStepJsonUrl('delta')" 
                                       target="_blank" 
                                       class="report-link"
                                       x-show="testStepResults.delta && testStepResults.delta.json_url">
                                        üì• Download Delta JSON Report
                                    </a>
                                </div>
                                <div class="generation-summary" x-show="testStepResults.delta.summary">
                                    <small x-text="`Generated ${testStepResults.delta.summary?.total_steps_generated || 0} steps`"></small>
                                </div>
                            </div>
                            
                            <!-- In-Place Reports -->
                            <div class="test-step-reports" x-show="testStepResults['in-place']">
                                <h4 class="generation-mode">üìù In-Place Mode:</h4>
                                <div class="report-links">
                                    <a :href="getTestStepExcelUrl('in-place')" 
                                       target="_blank" 
                                       class="report-link"
                                       x-show="testStepResults['in-place'] && testStepResults['in-place'].excel_url">
                                        üìà View In-Place Excel Report
                                    </a>
                                    <a :href="getTestStepJsonUrl('in-place')" 
                                       target="_blank" 
                                       class="report-link"
                                       x-show="testStepResults['in-place'] && testStepResults['in-place'].json_url">
                                        üì• Download In-Place JSON Report
                                    </a>
                                </div>
                                <div class="generation-summary" x-show="testStepResults['in-place'].summary">
                                    <small x-text="`Generated ${testStepResults['in-place'].summary?.total_steps_generated || 0} steps`"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-card" x-show="analysisResult && analysisResult.summary">
                        <div class="card-icon">üìä</div>
                        <div class="card-content">
                            <h3>Statistics</h3>
                            <div class="stats-list">
                                <div class="stat-item">
                                    <span class="stat-label">Total STTM Changes:</span>
                                    <span class="stat-value" x-text="analysisResult && analysisResult.summary ? (analysisResult.summary.total_sttm_changes || 0) : 0"></span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Test Cases Analyzed:</span>
                                    <span class="stat-value" x-text="analysisResult && analysisResult.summary ? (analysisResult.summary.total_test_cases || 0) : 0"></span>
                                </div>
                                <div class="stat-item" x-show="analysisResult && analysisResult.summary && analysisResult.summary.critical_impacts !== undefined">
                                    <span class="stat-label">Critical:</span>
                                    <span class="stat-value critical" x-text="analysisResult && analysisResult.summary ? (analysisResult.summary.critical_impacts || 0) : 0"></span>
                                </div>
                                <div class="stat-item" x-show="analysisResult && analysisResult.summary && analysisResult.summary.high_impacts !== undefined">
                                    <span class="stat-label">High:</span>
                                    <span class="stat-value high" x-text="analysisResult && analysisResult.summary ? (analysisResult.summary.high_impacts || 0) : 0"></span>
                                </div>
                                <div class="stat-item" x-show="analysisResult && analysisResult.summary && analysisResult.summary.priority_impacts !== undefined">
                                    <span class="stat-label">Priority Impacts:</span>
                                    <span class="stat-value priority" x-text="analysisResult && analysisResult.summary ? (analysisResult.summary.priority_impacts || 0) : 0"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </section>

            <!-- Error Display -->
            <div x-show="errorMessage" class="error-section">
                <div class="error-box">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span x-text="errorMessage"></span>
                    <button @click="clearError()" class="error-close">‚úï</button>
                </div>
            </div>

            <!-- Success Display -->
            <div x-show="successMessage" class="success-section">
                <div class="success-box">
                    <span class="success-icon">üéâ</span>
                    <span x-text="successMessage"></span>
                    <button @click="clearSuccess()" class="success-close">‚úï</button>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p>&copy; 2025 STTM Impact Analysis Tool - Phase 1: File Upload & Validation</p>
                <p class="version-info" x-show="versionInfo" x-text="versionInfo"></p>
            </div>
        </footer>
    </div>
</body>
</html>